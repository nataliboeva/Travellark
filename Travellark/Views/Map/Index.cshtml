@using Travellark.Models.Enums
@using System.Text.Json
@{
    ViewData["Title"] = "World Map";
    var destinations = ViewBag.Destinations;
    var visitedCount = (int)(ViewBag.VisitedCount ?? 0);
    var wishlistCount = (int)(ViewBag.WishlistCount ?? 0);
    var destinationsList = destinations as System.Collections.IEnumerable;
    var hasDestinations = destinationsList != null && destinationsList.Cast<object>().Any();
    var serializerOptions = new JsonSerializerOptions
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };
    var destinationsJson = destinations != null ? JsonSerializer.Serialize(destinations, serializerOptions) : "[]";
}

<div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
    <div>
        <p class="text-uppercase text-secondary small mb-1 fw-semibold">Explore visually</p>
        <h2 class="fw-semibold mb-0">World Map Overview</h2>
    </div>
    <div class="d-flex gap-2">
        <span class="badge bg-success-subtle text-success fw-semibold"><i class="bi bi-check-circle-fill me-1"></i>Visited @visitedCount</span>
        <span class="badge bg-secondary-subtle text-secondary fw-semibold"><i class="bi bi-bookmark-heart-fill me-1"></i>Wishlist @wishlistCount</span>
        @if (hasDestinations)
        {
            <span class="badge bg-primary-subtle text-primary fw-semibold"><i class="bi bi-pin-map-fill me-1"></i>@(destinationsList.Cast<object>().Count()) pins</span>
        }
    </div>
</div>

<div class="card border-0 shadow-soft mb-4 bg-gradient" style="background: radial-gradient(circle at top left, #f7f9ff, #ffffff);">
    <div class="card-body d-flex align-items-center gap-4 flex-wrap">
        <div class="d-flex align-items-center gap-3">
            <div class="icon-circle bg-primary-subtle text-primary">
                <i class="bi bi-globe-europe-africa"></i>
            </div>
            <div>
                <p class="text-muted small mb-1">See your adventures</p>
                <h5 class="mb-0 fw-semibold">Interactive world map with your destinations</h5>
            </div>
        </div>
        <div class="ms-auto text-muted small">
            Click on any marker to see quick details and jump to the destination page.
        </div>
    </div>
</div>

@if (hasDestinations)
{
    <div class="card border-0 shadow-soft">
        <div class="card-body p-0">
            <div id="map" style="height: 600px; width: 100%;"></div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-soft">
        <div class="card-body text-center py-5">
            <div class="icon-circle icon-circle-lg bg-secondary-subtle text-secondary mb-3">
                <i class="bi bi-map"></i>
            </div>
            <h5 class="mb-2 fw-semibold">No destinations with coordinates</h5>
            <p class="text-muted mb-3">Add coordinates to your destinations or select a spot from the map picker when creating/editing.</p>
            <a asp-controller="Destinations" asp-action="Create" class="btn btn-primary"><i class="bi bi-plus-circle me-1"></i>Add Destination</a>
        </div>
    </div>
}

@section Scripts {
    @if (hasDestinations)
    {
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        
        <script>
        // Initialize map
        var map = L.map('map').setView([20, 0], 2);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Destinations data
        var destinations = @Html.Raw(destinationsJson);

        // Create markers
        var visitedMarkers = [];
        var wishlistMarkers = [];

        destinations.forEach(function(dest) {
            var lat = dest.latitude;
            var lng = dest.longitude;
            var status = dest.status;
            var name = dest.name;
            var country = dest.country;
            var region = dest.region || '';
            var id = dest.id;
            var imageUrl = dest.imageUrl || '';
            var rating = dest.rating;

            // Create popup content
            var popupContent = '<div style="min-width: 200px;">';
            popupContent += '<h6 class="mb-2">' + name + '</h6>';
            popupContent += '<p class="text-muted small mb-2">' + country;
            if (region) {
                popupContent += ', ' + region;
            }
            popupContent += '</p>';
            
            if (rating) {
                popupContent += '<div class="mb-2">';
                for (var i = 0; i < rating; i++) {
                    popupContent += '<i class="fa-solid fa-star text-warning" style="font-size: 0.8rem;"></i>';
                }
                popupContent += '</div>';
            }
            
            popupContent += '<a href="/Destinations/Details/' + id + '" class="btn btn-sm btn-primary w-100">View Details</a>';
            popupContent += '</div>';

            // Choose marker color based on status
            var markerColor = status === 'Visited' ? '#198754' : '#6c757d';
            var icon = L.divIcon({
                html: '<div class="map-marker" style="background-color:' + markerColor + ';"><i class="bi ' + (status === 'Visited' ? 'bi-check-lg' : 'bi-heart') + '"></i></div>',
                iconSize: [32, 32],
                className: 'marker-wrapper'
            });

            var marker = L.marker([lat, lng], { icon: icon, riseOnHover: true })
                .addTo(map)
                .bindPopup(popupContent);

            if (status === 'Visited') {
                visitedMarkers.push(marker);
            } else {
                wishlistMarkers.push(marker);
            }
        });

        // Fit map to show all markers
        if (destinations.length > 0) {
            var group = new L.featureGroup(visitedMarkers.concat(wishlistMarkers));
            map.fitBounds(group.getBounds().pad(0.1));
        }

        // Layer control
        var visitedLayer = L.layerGroup(visitedMarkers);
        var wishlistLayer = L.layerGroup(wishlistMarkers);

        var overlayMaps = {
            "Visited": visitedLayer,
            "Wishlist": wishlistLayer
        };

        L.control.layers(null, overlayMaps).addTo(map);
    </script>

    <style>
        .map-marker {
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.2);
            font-size: 1rem;
        }

        .icon-circle {
            width: 48px;
            height: 48px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .icon-circle-lg {
            width: 64px;
            height: 64px;
            font-size: 1.5rem;
        }
    </style>
        }
    }
}

